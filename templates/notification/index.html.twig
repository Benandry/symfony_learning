{% extends "base.html.twig" %}


{% block body %}
<div class="container mt-5">
    <h1>Notifications</h1>

    <p> Le cle publique VAPID pour les notifications push est : </p>
    <pre>{{ vapid_public_key }}</pre>

    <h2>Activer les notifications </h2>
    <button id="enable-notifications" class="btn btn-primary">Activer les notifications</button>
    <button id="open-notification" class="btn btn-success">Declencher le notification</button>

    <div id="notification-status" class="mt-3"></div>

</div>

<script>
    const publicVapidKey = '{{ vapid_public_key }}';

    document.getElementById('open-notification').addEventListener('click', async () => {
        await fetch('{{ path('app_send_notification') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
          .then(data => {
              console.log('Notification sent:', data);
          })
          .catch(error => {
              console.error('Error sending notification:', error);
          });
    });

     document.getElementById('enable-notifications').addEventListener('click', async () => {
        console.log('Enabling notifications...'.navigator);
      if( 'serviceWorker' in navigator && 'PushManager' in window ) {
          try {
              const register = await navigator.serviceWorker.register('/sw.js', {
                  scope: '/'
              });
              console.log('Service Worker registered');

              const subscription = await register.pushManager.subscribe({
                  userVisibleOnly: true,
                  applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
              });

              await fetch('{{ path('app_subscriber') }}', {
                  method: 'POST',
                  body: JSON.stringify(subscription),
                  headers: {
                      'Content-Type': 'application/json'
                  }
              });

              document.getElementById('notification-status').innerText = 'Notifications activÃ©es !';
          } catch (error) {
              console.error('Error during service worker registration or push subscription:', error);
          }
          
      } 
      
    });

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    
</script>
{% endblock %}